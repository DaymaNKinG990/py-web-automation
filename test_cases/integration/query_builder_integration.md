# Query Builder Integration Test Cases

## Overview
Integration tests for QueryBuilder with DBClient.
Tests verify SQL query construction, execution, and integration with database operations.

## Test Categories

### 1. QueryBuilder with DBClient

#### TC-INTEGRATION-QB-001: QueryBuilder с DBClient - полный SQL workflow
- **Purpose**: Verify QueryBuilder integrates with DBClient for complete SQL workflows
- **Preconditions**:
  - DBClient instance (SQLite, PostgreSQL, or MySQL)
  - Database connection available
  - Test table created
- **Test Steps**:
  1. Create DBClient with database connection string
  2. Connect to database using `connect()`
  3. Create test table using `execute_command()`:
     ```sql
     CREATE TABLE IF NOT EXISTS test_users (
         id INTEGER PRIMARY KEY,
         name TEXT,
         email TEXT,
         active BOOLEAN
     )
     ```
  4. Create QueryBuilder instance
  5. Build SELECT query using QueryBuilder:
     ```python
     query, params = (QueryBuilder()
         .select("id", "name", "email")
         .from_table("test_users")
         .where("active", "=", True)
         .build())
     ```
  6. Execute query using `DBClient.execute_query(query, params)`
  7. Verify query executed successfully:
     - Results returned
     - Query structure correct
     - Parameters bound correctly
- **Expected Result**: QueryBuilder generates valid SQL, DBClient executes it successfully
- **Coverage**: QueryBuilder.build(), DBClient.execute_query(), SQL generation
- **Dependencies**: DBClient, QueryBuilder, database connection

#### TC-INTEGRATION-QB-002: QueryBuilder SELECT queries с DBClient
- **Purpose**: Verify SELECT queries generated by QueryBuilder work with DBClient
- **Preconditions**:
  - DBClient instance with database connection
  - Test table with data
- **Test Steps**:
  1. Create DBClient and connect to database
  2. Insert test data using `execute_command()`:
     ```sql
     INSERT INTO test_users (name, email, active) VALUES
     ('John Doe', 'john@example.com', 1),
     ('Jane Smith', 'jane@example.com', 1),
     ('Bob Johnson', 'bob@example.com', 0)
     ```
  3. Create QueryBuilder and build SELECT query:
     ```python
     query, params = (QueryBuilder()
         .select("id", "name", "email")
         .from_table("test_users")
         .where("active", "=", True)
         .order_by("name", "ASC")
         .limit(10)
         .build())
     ```
  4. Execute query using `DBClient.execute_query(query, params)`
  5. Verify results:
     - 2 rows returned (John and Jane, active=True)
     - Results ordered by name
     - Results limited to 10 rows
  6. Verify query structure:
     - SELECT clause correct
     - WHERE clause correct
     - ORDER BY clause correct
     - LIMIT clause correct
- **Expected Result**: SELECT queries generated by QueryBuilder execute correctly with DBClient
- **Coverage**: QueryBuilder SELECT queries, DBClient.execute_query()
- **Dependencies**: DBClient, QueryBuilder

#### TC-INTEGRATION-QB-003: QueryBuilder INSERT queries с DBClient
- **Purpose**: Verify INSERT queries generated by QueryBuilder work with DBClient
- **Preconditions**:
  - DBClient instance with database connection
  - Test table created
- **Test Steps**:
  1. Create DBClient and connect to database
  2. Create QueryBuilder and build INSERT query:
     ```python
     query, params = (QueryBuilder()
         .insert("test_users")
         .values({
             "name": "Alice Brown",
             "email": "alice@example.com",
             "active": True
         })
         .build())
     ```
  3. Execute query using `DBClient.execute_command(query, params)`
  4. Verify insert succeeded:
     - Row inserted into database
     - No errors raised
  5. Query inserted row using SELECT:
     ```python
     query, params = (QueryBuilder()
         .select("*")
         .from_table("test_users")
         .where("email", "=", "alice@example.com")
         .build())
     ```
  6. Execute SELECT query and verify inserted data:
     - Row found
     - Data matches inserted values
- **Expected Result**: INSERT queries generated by QueryBuilder execute correctly with DBClient
- **Coverage**: QueryBuilder INSERT queries, DBClient.execute_command()
- **Dependencies**: DBClient, QueryBuilder

#### TC-INTEGRATION-QB-004: QueryBuilder UPDATE queries с DBClient
- **Purpose**: Verify UPDATE queries generated by QueryBuilder work with DBClient
- **Preconditions**:
  - DBClient instance with database connection
  - Test table with data
- **Test Steps**:
  1. Create DBClient and connect to database
  2. Insert test data (if not exists)
  3. Create QueryBuilder and build UPDATE query:
     ```python
     query, params = (QueryBuilder()
         .update("test_users")
         .set({"active": False})
         .where("email", "=", "john@example.com")
         .build())
     ```
  4. Execute query using `DBClient.execute_command(query, params)`
  5. Verify update succeeded:
     - Row updated in database
     - No errors raised
  6. Query updated row using SELECT:
     ```python
     query, params = (QueryBuilder()
         .select("active")
         .from_table("test_users")
         .where("email", "=", "john@example.com")
         .build())
     ```
  7. Execute SELECT query and verify updated data:
     - active = False
- **Expected Result**: UPDATE queries generated by QueryBuilder execute correctly with DBClient
- **Coverage**: QueryBuilder UPDATE queries, DBClient.execute_command()
- **Dependencies**: DBClient, QueryBuilder

#### TC-INTEGRATION-QB-005: QueryBuilder DELETE queries с DBClient
- **Purpose**: Verify DELETE queries generated by QueryBuilder work with DBClient
- **Preconditions**:
  - DBClient instance with database connection
  - Test table with data
- **Test Steps**:
  1. Create DBClient and connect to database
  2. Insert test data (if not exists)
  3. Create QueryBuilder and build DELETE query:
     ```python
     query, params = (QueryBuilder()
         .delete()
         .from_table("test_users")
         .where("email", "=", "bob@example.com")
         .build())
     ```
  4. Execute query using `DBClient.execute_command(query, params)`
  5. Verify delete succeeded:
     - Row deleted from database
     - No errors raised
  6. Query deleted row using SELECT:
     ```python
     query, params = (QueryBuilder()
         .select("*")
         .from_table("test_users")
         .where("email", "=", "bob@example.com")
         .build())
     ```
  7. Execute SELECT query and verify row deleted:
     - No rows returned
- **Expected Result**: DELETE queries generated by QueryBuilder execute correctly with DBClient
- **Coverage**: QueryBuilder DELETE queries, DBClient.execute_command()
- **Dependencies**: DBClient, QueryBuilder

#### TC-INTEGRATION-QB-006: QueryBuilder complex queries - JOIN, GROUP BY, HAVING
- **Purpose**: Verify complex queries with JOIN, GROUP BY, HAVING work with DBClient
- **Preconditions**:
  - DBClient instance with database connection
  - Multiple test tables with relationships
- **Test Steps**:
  1. Create DBClient and connect to database
  2. Create test tables:
     ```sql
     CREATE TABLE orders (id INTEGER PRIMARY KEY, user_id INTEGER, total REAL);
     CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT);
     ```
  3. Insert test data
  4. Create QueryBuilder and build complex query:
     ```python
     query, params = (QueryBuilder()
         .select("users.name", "COUNT(orders.id) as order_count", "SUM(orders.total) as total")
         .from_table("users")
         .join("INNER", "orders", "users.id", "orders.user_id")
         .group_by("users.id", "users.name")
         .having("COUNT(orders.id)", ">", 1)
         .order_by("total", "DESC")
         .build())
     ```
  5. Execute query using `DBClient.execute_query(query, params)`
  6. Verify complex query executed successfully:
     - JOIN clause correct
     - GROUP BY clause correct
     - HAVING clause correct
     - Results aggregated correctly
     - Results ordered correctly
- **Expected Result**: Complex queries with JOIN, GROUP BY, HAVING execute correctly
- **Coverage**: QueryBuilder complex queries, DBClient.execute_query()
- **Dependencies**: DBClient, QueryBuilder

#### TC-INTEGRATION-QB-007: QueryBuilder с транзакциями DBClient
- **Purpose**: Verify QueryBuilder works with DBClient transactions
- **Preconditions**:
  - DBClient instance with database connection
  - Test table created
- **Test Steps**:
  1. Create DBClient and connect to database
  2. Begin transaction using `DBClient.begin_transaction()`
  3. Create QueryBuilder and build INSERT query:
     ```python
     query, params = (QueryBuilder()
         .insert("test_users")
         .values({
             "name": "Transaction Test",
             "email": "transaction@example.com",
             "active": True
         })
         .build())
     ```
  4. Execute query within transaction using `DBClient.execute_command(query, params)`
  5. Verify row inserted (within transaction)
  6. Rollback transaction using `DBClient.rollback()`
  7. Verify row NOT persisted (rolled back)
  8. Begin new transaction
  9. Execute INSERT query again
  10. Commit transaction using `DBClient.commit()`
  11. Verify row persisted (committed)
- **Expected Result**: QueryBuilder queries work correctly within DBClient transactions
- **Coverage**: QueryBuilder with DBClient transactions (begin, commit, rollback)
- **Dependencies**: DBClient, QueryBuilder

